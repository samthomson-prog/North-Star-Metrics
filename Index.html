<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>North Star Metrics - Live Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 p-6 font-sans min-h-screen">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold text-pink-500 mb-6">North Star Metrics</h1>
    <div class="mb-4">
      <label for="month" class="block text-sm font-medium">Select Month</label>
      <select id="month" class="mt-1 p-2 bg-gray-800 rounded text-white"></select>
    </div>
    <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRmn96vxxx71rvxX7Q3pnj16KtJeEEOaSLM-mF1kkq1SoWpuBH089S0TnGtRW7imST3QxNDmuXBTnFG/pub?output=csv';

    const metrics = [
      { key: 'Revenue', label: 'Revenue' },
      { key: 'Capital_Raised', label: 'Capital Raised' },
      { key: 'New_WS_Investors', label: 'New WS Investors' },
      { key: 'New_Premium_Raises', label: 'New Premium Raises' },
      { key: 'New_Property_Projects', label: 'New Property Projects' },
      { key: 'New_Managed_Funds', label: 'New Managed Funds' },
    ];

    const monthSelect = document.getElementById('month');
    const dashboard = document.getElementById('dashboard');
    let parsedData = [];

    function fetchData() {
      fetch(sheetUrl)
        .then(res => res.text())
        .then(csv => {
          const rows = csv.trim().split('\n').map(row => row.split(','));
          const headers = rows[0];
          parsedData = rows.slice(1).map(row => {
            const obj = {};
            headers.forEach((header, i) => {
              obj[header.trim()] = row[i] ? row[i].trim() : '';
            });
            return obj;
          });

          populateMonths(parsedData);
          monthSelect.addEventListener('change', () => renderDashboard(monthSelect.value));
          renderDashboard(monthSelect.value);
        });
    }

    function populateMonths(data) {
      data.forEach(row => {
        const opt = document.createElement('option');
        opt.value = row.Month;
        opt.textContent = row.Month;
        monthSelect.appendChild(opt);
      });
    }

    function renderDashboard(selectedMonth) {
      dashboard.innerHTML = '';
      const row = parsedData.find(r => r.Month === selectedMonth);
      if (!row) return;

      metrics.forEach(metric => {
        const actual = parseFloat(row[`${metric.key}_Actual`] || 0);
        const target = parseFloat(row[`${metric.key}_Target`] || 0);
        const variance = actual - target;
        const percent = target ? (actual / target * 100).toFixed(1) : 0;

        const card = document.createElement('div');
        card.className = "bg-gray-800 rounded-lg p-5 shadow";

        card.innerHTML = `
          <h2 class="text-xl font-semibold text-pink-400 mb-3">${metric.label}</h2>
          <div class="text-sm">Actual: <span class="font-bold text-white">${formatNumber(actual)}</span></div>
          <div class="text-sm">Target: <span class="font-bold text-white">${formatNumber(target)}</span></div>
          <div class="text-sm">Variance: <span class="font-bold ${variance < 0 ? 'text-red-400' : 'text-green-400'}">${formatNumber(variance)}</span></div>
          <div class="w-full bg-gray-700 h-2 rounded-full mt-3">
            <div class="h-2 rounded-full bg-pink-500" style="width: ${Math.min(percent, 100)}%"></div>
          </div>
          <div class="text-xs mt-1 text-right">${percent}%</div>
        `;

        dashboard.appendChild(card);
      });
    }

    function formatNumber(num) {
      if (isNaN(num)) return '-';
      return num >= 1000000 ? `$${(num / 1e6).toFixed(1)}M` :
             num >= 1000 ? `$${(num / 1e3).toFixed(1)}k` :
             `$${num.toFixed(0)}`;
    }

    fetchData();
  </script>
</body>
</html>
